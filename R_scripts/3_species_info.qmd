---
title: "3_species_info"
author: "Shayna A. Sura"
format: html
---

## Refining list of fish species & gathering information on their climate zone preferences from FishBase



```{r setup}

library(tidyverse) # includes and loads the packages listed below
# library(readr)
# library(tidyr)
# library(dplyr)
# library(ggplot2)
# library(lubridate)

library(here) # helps with paths for files

library(purrr)

library(rvest) #for web scraping
library(xml2)
library(stringr)


```



```{r reading in cleaned bio data}
#| echo: false
#| message: false

bio_data_clean <- read_csv(file = "data/clean_data/bio_data.csv")

# head(bio_data_clean)

```



## Misspelled entries in the TAXONOMIC column - should eventually be fixed with the CIU_BIOCODES and new_TAXON columns from 1_organize_data script...still have one misspelling version of Aluterus heudelotii that is not linked to an UPDATED_TAXON name change in the recent biocodes file (BIOCODES01182023.csv)
 - ALUTERUS HEUDELOTTI -> ALUTERUS HEUDELOTII




## Species Names in SEAMAP Trawl Data that do NOT align with FishBase Spellings:
- APOGON ALUTUS -> ASTRAPOGON ALUTUS
- ALUTERUS HEUDELOTTII -> ALUTERUS HEUDELOTII
- ANCYLOPSETTA OMMATA -> ANCYLOPSETTA QUADROCELLATA
- ELACATINU HORSTI -> ELACATINUS HORSTI
- EUCINOSTOMUS PSEUDOGULA -> EUCINOSTOMUS JONESII
- SCORPAENA TRIDECIMSPINOSA -> SCORPAENODES TREDECIMSPINOSUS
- SPARISOMA ATROMARIUM -> SPARISOM ATOMARIUM
- TETRAPTURUS PFLEUGERI -> Tetrapturus pfluegeri | TETRAPTURUS PFLUEGERI
- UROPHYCIS EARLLI -> UROPHYCIS EARLLII
- UROPHYCIS N SP CF EARLLII -> UROPHYCIS EARLLII


## Fixed with updated biocodes csv from mid-April 2024 ((BIOCODES01182023.csv))
- ARIOSOMA BELEARICUM -> ARIOSOMA BALEARICUM
- BENTHODESMUS ATLANTICUS - no longer accepted, is now Benthodesmus simonyi
- BROTULA BARBATUM -> Brotula barbata
- CAELORINCHUS CARIBBAEUS -> Coelorinchus caribbaeus (and associated congeners)  
- CENTROPRISTIS PHILADELPHICUS -> Centropristis philadelphica


```{r updates to fish species taxonomic names}

## run this code to update some misspellings of fish species taxonomic names I've encountered

clean_data_to_update <- bio_data_clean


clean_data_to_update <- yr2010_2022_m678_clean_bio_data # FILL IN HERE
  
clean_data_to_update <- clean_data_to_update %>% 
  mutate(new_TAXON = case_when((new_TAXON == "APOGON ALUTUS") ~ "ASTRAPOGON ALUTUS", .default = new_TAXON),
         new_TAXON = case_when((new_TAXON == "ALUTERUS HEUDELOTTII") ~ "ALUTERUS HEUDELOTII", .default = new_TAXON),
         new_TAXON = case_when((new_TAXON == "ANCYLOPSETTA OMMATA") ~ "ANCYLOPSETTA QUADROCELLATA", .default = new_TAXON),
         new_TAXON = case_when((new_TAXON == "ELACATINU HORSTI") ~ "ELACATINUS HORSTI", .default = new_TAXON),
         new_TAXON = case_when((new_TAXON == "EUCINOSTOMUS PSEUDOGULA") ~ "EUCINOSTOMUS JONESII", .default = new_TAXON),
         new_TAXON = case_when((new_TAXON == "SCORPAENA TRIDECIMSPINOSA") ~ "SCORPAENODES TREDECIMSPINOSUS", .default = new_TAXON),
         new_TAXON = case_when((new_TAXON == "SPARISOMA ATROMARIUM") ~ "SPARISOMA ATOMARIUM", .default = new_TAXON),
         new_TAXON = case_when((new_TAXON == "SPARISOM ATOMARIUM") ~ "SPARISOMA ATOMARIUM", .default = new_TAXON),
         new_TAXON = case_when((new_TAXON == "TETRAPTURUS PFLEUGERI") ~ "TETRAPTURUS PFLUEGERI", .default = new_TAXON),
         new_TAXON = case_when((new_TAXON == "UROPHYCIS EARLLI") ~ "UROPHYCIS EARLLII", .default = new_TAXON),
         new_TAXON = case_when((new_TAXON == "UROPHYCIS N SP CF EARLLII") ~ "UROPHYCIS EARLLII", .default = new_TAXON)
  )


bio_data_clean <- clean_data_to_update
yr2010_2022_m678_clean_bio_data <- clean_data_to_update

```







### Refine list of fish species to do all analyses and plotting for! >1000 unique fish 'species' is too many.

- only keep the unique new_TAXON entries that are identified to the SPECIES rank level
- arrange in alphabetical order

(previously) - only keep unique TAXONOMIC entries that have 2 words (Genus species) versus just 1 word (family or genus level only)


```{r extract unique fish species names}

# Extract unique fish species taxonomic names - ONLY fishes identified to species level - returns a dataframe

species_df <- bio_data_clean %>% 
  select(new_TAXON, RANK) %>% 
  filter(RANK == "SPECIES") %>% 
  distinct(new_TAXON, .keep_all = TRUE) %>% 
  arrange(new_TAXON)


dim(species_df)  ## returns 843 unique taxonomic names after name adjustments above


species_list <- species_df$new_TAXON  # converts to vector format so can be used in apply / mapping below to use function on all the species names in this vector
length(species_list)



# ## species list for 2010 - 2022 data only
# post2010_species_df <- post2010_clean_bio_data %>% 
#   select(new_TAXON, RANK) %>% 
#   filter(RANK == "SPECIES") %>% 
#   distinct(new_TAXON, .keep_all = TRUE) %>% 
#   arrange(new_TAXON)
# 
# dim(post2010_species_df)  ## returns 514 unique taxonomic names
# 
# post2010_species_list <- post2010_species_df$new_TAXON  # converts to vector format so can be used in apply / mapping below to use function on all the species names in this vector
# length(post2010_species_list)


## species list for 2010 - 2022 summer months (6,7,8) data only
yr2010_2022_m687_species_df <- yr2010_2022_m678_clean_bio_data %>% 
  select(new_TAXON, RANK) %>% 
  filter(RANK == "SPECIES") %>% 
  distinct(new_TAXON, .keep_all = TRUE) %>% 
  arrange(new_TAXON)

dim(yr2010_2022_m687_species_df) # 513 unique taxonomic names
yr2010_2022_m687_species_list <- yr2010_2022_m687_species_df$new_TAXON
length(yr2010_2022_m687_species_list) # 513 unique taxonomic names




# ## need to remove the occurrence of CALAMUS PRORIDENS/NODOSUS in the fish species list because it causes problems when trying to scrape data from FishBase
# 
# species_df <- unique(bio_data_clean[grep("\\b\\w+\\s\\w+\\b", bio_data_clean$new_TAXON), "new_TAXON"]) %>% 
#   # filter(TAXONOMIC != "CALAMUS PRORIDENS/NODOSUS") %>% 
#   arrange(new_TAXON)


# # Extract unique fish species taxonomic names - includes taxonomic names to family, genus, and species level
# species_list <- na.omit(unique(bio_data_clean$TAXONOMIC))
# length(species_list) ## returns 1,166 unique taxonomic names


# # Extract unique fish species taxonomic names - ONLY fishes identified to species level - returns a list
# species_df <- bio_data_clean[grep("\\b\\w+\\s\\w+\\b", bio_data_clean$TAXONOMIC), ]
# species_list_2 <- unique(species_df$TAXONOMIC)
# length(species_list_2) ## returns 847 unique taxonomic names

```



## (future) Write code to check list of fish species scientific names versus what is currently accepted in FishBase
### don't do this for now - this information is being updated in the SEAMAP trawl databases
### in the R script "1_organize_data.qmd", we check the UPDATED_TAXON column for an updated scientific name for fish species
#### SEAMAP organizers have updated the information for Centropristis philadelphicus, but not for all species I've identified above yet.

```{r manually updated fish scientific names}

# 
# ## the taxonomic name for the Rock Sea Bass in the SEAMAP trawl data is currently "CENTROPRISTIS PHILADELPHICUS", but on FishBase, the scientific name given is "Centropristis philadelphica"
# 
# bio_data_clean <- bio_data_clean %>% 
#   mutate(TAXONOMIC = case_when((TAXONOMIC == "CENTROPRISTIS PHILADELPHICUS") ~ "Centropristis philadelphica", .default = TAXONOMIC))
# 
# 
# ## the taxonomic name for the Bandtooth conger in the SEAMAP trawl data is currently "ARIOSOMA BELEARICUM", but on FishBase, the scientific name given is "Ariosoma balearicum"
# 
# 
# ## the taxonomic name for the bearded brotula in the SEAMAP trawl data is currently "BROTULA BARBATUM", but on FishBase, the scientific name given is "Brotula barbata"
# 

```









# FishBase Function - scrape information from FishBase to determine the climate zone information for each fish species.

## side note - the rfishbase package looks helpful for extracting most information from FishBase. Unfortunately, the information I need to extract is not found in a table, so this package doesn't work for me.


```{r web scraping FishBase for fish species distribution information}


# library(rvest)
# library(xml2)
# library(stringr)

# Function to scrape climate zone information from FishBase
get_climate_zone <- function(species_name) {
  # Construct the URL for the FishBase search page
  base_url <- "https://www.fishbase.se/summary/"
  search_url <- paste0(base_url, gsub(" ", "-", tolower(species_name)))
 
  # Fetch the HTML content of the search page
  search_page <- read_html(search_url)
 
  # Find the <h1> element containing the word "Environment" and get the following sibling <div>
  environment_section <- search_page %>%
    html_elements(xpath = "//h1[contains(translate(., 'ENVIRONMENT', 'environment'), 'environment')]/following-sibling::div[1]") %>%
    html_text(trim = TRUE) %>%
    tolower()
 
  # Check if environment information is found
  if (length(environment_section) == 0) {
    warning(paste("No environment information found for the species:", species_name))
    return(NA)
  }
 
  # Extract climate zone information from the Environment text
  climate_zones <- c("subtropical", "tropical", "temperate", "polar", "deep-water")
  climate_zone <- NA
 
  for (zone in climate_zones) {
    if (str_detect(environment_section, fixed(zone, ignore_case = TRUE))) {
      climate_zone <- zone
      break
    }
  }
 
  # Print environment text for diagnostics
  cat("Environment Text:", environment_section, "\n")
 
  # Return climate zone information
  return(climate_zone)
}

# Test the function for "Epinephelus morio"
species_name <- "Epinephelus morio"
climate_zone <- get_climate_zone(species_name)
print(climate_zone)


```



```{r loop through FishBase function to get information for every fish species}

# Iterate through each unique fish species - use the species_list from above which only includes fishes identified to species level (847 species)

# Initialize an empty data frame to store results
species_climate_df <- data.frame(species_name = character(), climate_zone = character(), stringsAsFactors = FALSE)

for (species in species_list) {
  # Get the climate zone for the species
  climate_zone <- get_climate_zone(species)
  
  # Append the species name and climate zone to the data frame
  species_climate_df <- rbind(species_climate_df, data.frame(species_name = species, climate_zone = climate_zone))
}

# # Print the resulting data frame
# print(species_climate_df)
# 
# # View the resulting data frame
# view(species_climate_df)

# Create csv file with species climate information
write_csv(species_climate_df, file = "output/species_climate_data.csv")



```







