---
title: "species_year_loop"
author: "CRF"
date: "2024-07-26"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r }
# Load necessary libraries
library(dplyr)
library(sf)
library(terra)
library(spatstat)
library(tidyverse)

#  dataframe
bio_data_clean_all <- read_csv("~/Desktop/tropicalization-gom/bio_data_clean.csv")
species_climate_df <- read_csv("~/Desktop/tropicalization-gom/species_climate_data.csv")
bio_data_final <- bio_data_clean_all %>%
  rename(species_name = new_TAXON) %>%
  left_join(species_climate_df, join_by(species_name)) %>% 
  rename(new_TAXON = species_name) #584,783

bio_data_final<-bio_data_final %>% drop_na("SELECT_BGS") #579,868 observations
bio_data_final<-bio_data_final %>% drop_na("new_TAXON") #579,8683 observations




#for testing/debugging
#yr=2015
#sp="PTEROIS VOLITANS"
#which(is.na(bio_data_final$DECSLAT), arr.ind=TRUE)
#which(is.na(bio_data_final$DECSLON), arr.ind=TRUE)
#which(is.na(bio_data_final$SELECT_BGS), arr.ind=TRUE) #this returns 3,915 entries. I'm going to omit them
#which(is.na(bio_data_final$YR), arr.ind=TRUE)
#which(is.na(bio_data_final$new_TAXON), arr.ind=TRUE) # 5 entry that's messing it up!
    


# Create an empty list to store raster stacks for each species
species_raster_stacks <- list()

# Loop over each species
for (sp in unique(bio_data_final$new_TAXON)) {
  # Filter data for the current species
  species_data <- bio_data_final %>% filter(new_TAXON == sp) 
  
  # Create an empty list to store rasters for each year
  yearly_rasters <- list()
  
  # Loop over each year
  for (yr in unique(species_data$YR)) {
    # Filter data for the current year
    year_data <- species_data %>% filter(YR == yr) 

    # Remove duplicate points
    year_data <- year_data %>% distinct(DECSLON, DECSLAT)

    # Convert the dataframe to an sf object
    year_data_sf <- st_as_sf(year_data, coords = c("DECSLON", "DECSLAT"), crs = 4269)

    # Convert sf object to a data frame for KDE
    coords <- st_coordinates(year_data_sf)

    # Perform Kernel Density Estimation
    kde <- density.ppp(ppp(coords[, 1], coords[, 2], window = owin(c(-100, -80), c(20, 35)))) 

    # Create a raster from the KDE output
    # Create an empty raster with specified extent and resolution
    raster_template <- rast(ext = ext(-100, -80, 20, 35), res = 0.01)
    
    # Rasterize the KDE results
    kde_raster <- rast(nrows = nrow(raster_template), ncols = ncol(raster_template), 
                       ext = ext(raster_template), crs = crs(raster_template))
    
    # Assign the KDE values to the raster
    values(kde_raster) <- as.vector(kde$v)

    # Store the KDE raster in the list
    yearly_rasters[[as.character(yr)]] <- kde_raster
  }
  
  # Stack the yearly rasters into a single raster stack
  species_raster_stack <- rast(yearly_rasters)
  
  # Add the raster stack to the list of species raster stacks
  species_raster_stacks[[sp]] <- species_raster_stack 
}

# Example of accessing the raster stack for a specific species
rt <- species_raster_stacks$`RHIZOPRIONODON TERRAENOVAE`
rt.sum <- app(rt, fun = sum, na.rm = TRUE)
plot(rt.sum)





```


```{r}


rt<-species_raster_stacks$`RHIZOPRIONODON TERRAENOVAE`
rt.sum<-app(rt, fun=sum, na.rm=TRUE)
plot(rt.sum)


```

the kde part of this bit below is broken. mismatch between kde and empty raster
```{r kde}
# Load necessary libraries
library(dplyr)
library(sf)
library(terra)
library(spatstat)
library(raster)


# Create an empty list to store raster stacks for each species
species_raster_stacks <- list()

# Loop over each species
for (sp in unique(bio_data_final$new_TAXON)) {
  # Filter data for the current species
  species_data <- bio_data_final %>% filter(new_TAXON == sp) 
  
  # Create an empty list to store rasters for each year
  yearly_rasters <- list()
  
  # Loop over each year
  for (yr in unique(species_data$YR)) {
    # Filter data for the current year
    year_data <- species_data %>% filter(YR == yr) 

    # Remove duplicate points
    year_data <- year_data %>% distinct(DECSLON, DECSLAT)

    # Convert the dataframe to an sf object
    year_data_sf <- st_as_sf(year_data, coords = c("DECSLON", "DECSLAT"), crs = 4269)

    # Convert sf object to a data frame for KDE
    coords <- st_coordinates(year_data_sf)

    # Perform Kernel Density Estimation
    kde <- density.ppp(ppp(coords[, 1], coords[, 2], window = owin(c(-100, -80), c(20, 35)))) 

    # Create a raster from the KDE output
    # Create an empty raster with specified extent and resolution
    raster_template <- rast(ext = ext(-100, -80, 20, 35), res = 0.01)
    
    # Rasterize the KDE results
    kde_raster <- rast(nrows = nrow(raster_template), ncols = ncol(raster_template), 
                       ext = ext(raster_template), crs = crs(raster_template))
    
    # Assign the KDE values to the raster
    values(kde_raster) <- as.vector(kde$v)

    # Store the KDE raster in the list
    yearly_rasters[[as.character(yr)]] <- kde_raster
  }
  
  # Stack the yearly rasters into a single raster stack
  species_raster_stack <- rast(yearly_rasters)
  
  # Add the raster stack to the list of species raster stacks
  species_raster_stacks[[sp]] <- species_raster_stack 
}

# Example of accessing the raster stack for a specific species
rt <- species_raster_stacks$`RHIZOPRIONODON TERRAENOVAE`
rt.sum <- app(rt, fun = sum, na.rm = TRUE)
plot(rt.sum)





```

```{r}


rt<-species_raster_stacks$`RHIZOPRIONODON TERRAENOVAE`
rt.sum<-app(rt, fun=sum, na.rm=TRUE)
plot(rt.sum)


```
