---
title: "species_year_loop"
author: "CRF"
date: "2024-07-26"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r }
# Load necessary libraries
library(dplyr)
library(terra)
library(sf)
library(tidyverse)

#  dataframe
bio_data_clean_all <- read_csv("~/Desktop/tropicalization-gom/bio_data_clean.csv")
species_climate_df <- read_csv("~/Desktop/tropicalization-gom/species_climate_data.csv")
bio_data_final <- bio_data_clean_all %>%
  rename(species_name = new_TAXON) %>%
  left_join(species_climate_df, join_by(species_name)) %>% 
  rename(new_TAXON = species_name) #584,783

bio_data_final<-bio_data_final %>% drop_na("SELECT_BGS") #579,868 observations
bio_data_final<-bio_data_final %>% drop_na("new_TAXON") #579,8683 observations




#for testing/debugging
#yr=2015
#sp="PTEROIS VOLITANS"
#which(is.na(bio_data_final$DECSLAT), arr.ind=TRUE)
#which(is.na(bio_data_final$DECSLON), arr.ind=TRUE)
#which(is.na(bio_data_final$SELECT_BGS), arr.ind=TRUE) #this returns 3,915 entries. I'm going to omit them
#which(is.na(bio_data_final$YR), arr.ind=TRUE)
#which(is.na(bio_data_final$new_TAXON), arr.ind=TRUE) # 5 entry that's messing it up!
    


# Create an empty list to store raster stacks for each species
species_raster_stacks <- list()

# Loop over each species
for (sp in unique(bio_data_final$new_TAXON)) {
  # Filter data for the current species
  species_data <- bio_data_final %>% filter(new_TAXON == sp) 
  
  # Create an empty list to store rasters for each year
  yearly_rasters <- list()
  
  # Loop over each year
  for (yr in unique(species_data$YR)) {
    # Filter data for the current year
    year_data <- species_data %>% filter(YR == yr) 
    
    # Convert the dataframe to an sf object
    year_data_sf <- st_as_sf(year_data, coords = c( "DECSLON", "DECSLAT"), crs = 4269)
    
    # Define the raster extent (you may need to adjust the extent based on your data)
    raster_extent <- ext(-100, -80, 20, 35)

    # Create a raster template with the desired resolution (adjust resolution as needed)
    raster_template <- rast(ext = raster_extent, res = 0.01)
    crs(raster_template) <- "EPSG:4269"

    # Rasterize the points for the current year
    year_raster <- rasterize(year_data_sf, raster_template, field = "SELECT_BGS")
    
    # Add the year raster to the list of yearly rasters
    yearly_rasters[[as.character(yr)]] <- year_raster 
  }
  
  # Stack the yearly rasters into a single raster stack
  species_raster_stack <- rast(yearly_rasters)
  
  # Add the raster stack to the list of species raster stacks
  species_raster_stacks[[sp]] <- species_raster_stack 
}





```


```{r}


rt<-species_raster_stacks$`RHIZOPRIONODON TERRAENOVAE`
rt.sum<-app(rt, fun=sum, na.rm=TRUE)
plot(rt.sum)


```

